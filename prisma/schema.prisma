generator client {
  provider                    = "prisma-client-py"
  interface                   = "asyncio"
  recursive_type_depth        = 5
  enable_experimental_decimal = true
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserStatus {
  PENDING
  ACTIVE
  INACTIVE
  BANNED
}

enum TransactionType {
  BUY
  SELL
  TOPUP
  WITHDRAW
  REFERRAL_BONUS
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model User {
  id            String      @id @default(cuid())
  telegramId    BigInt      @unique @map("telegram_id")
  username      String?
  firstName     String?     @map("first_name")
  lastName      String?     @map("last_name")
  email         String?
  whatsapp      String?
  latitude      Float?
  longitude     Float?
  referralCode  String      @unique @map("referral_code")
  referredById  String?     @map("referred_by_id")
  referredBy    User?       @relation("Referrals", fields: [referredById], references: [id])
  referrals     User[]      @relation("Referrals")
  status        UserStatus  @default(PENDING)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  lastActiveAt  DateTime    @default(now()) @map("last_active_at")

  balance       Balance?
  transactions  Transaction[]
  deposits      Deposit[]
  withdrawals   Withdrawal[]
  cryptoOrders  CryptoOrder[]

  @@map("users")
}

model Balance {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Decimal  @default(0) @db.Decimal(20, 2)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("balances")
}

model Transaction {
  id          String            @id @default(cuid())
  userId      String            @map("user_id")
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        TransactionType
  amount      Decimal           @db.Decimal(20, 2)
  description String?
  status      TransactionStatus @default(PENDING)
  metadata    Json?
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  @@map("transactions")
}

model Deposit {
  id              String            @id @default(cuid())
  userId          String            @map("user_id")
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount          Decimal           @db.Decimal(20, 2)
  paymentMethod   String            @map("payment_method")
  proofImage      String?           @map("proof_image")
  status          TransactionStatus @default(PENDING)
  adminNote       String?           @map("admin_note")
  approvedById    String?           @map("approved_by_id")
  approvedBy      Admin?            @relation(fields: [approvedById], references: [id])
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@map("deposits")
}

model Withdrawal {
  id              String            @id @default(cuid())
  userId          String            @map("user_id")
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount          Decimal           @db.Decimal(20, 2)
  bankName        String?           @map("bank_name")
  accountNumber   String?           @map("account_number")
  accountName     String?           @map("account_name")
  ewalletType     String?           @map("ewallet_type")
  ewalletNumber   String?           @map("ewallet_number")
  status          TransactionStatus @default(PENDING)
  adminNote       String?           @map("admin_note")
  approvedById    String?           @map("approved_by_id")
  approvedBy      Admin?            @relation(fields: [approvedById], references: [id])
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  @@map("withdrawals")
}

enum OrderType {
  BUY
  SELL
}

enum OrderStatus {
  PENDING
  AWAITING_PAYMENT
  AWAITING_CRYPTO
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  EXPIRED
}

model CryptoOrder {
  id                String        @id @default(cuid())
  userId            String        @map("user_id")
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderType         OrderType     @map("order_type")
  coinSymbol        String        @map("coin_symbol")
  network           String
  cryptoAmount      Decimal       @db.Decimal(30, 18) @map("crypto_amount")
  fiatAmount        Decimal       @db.Decimal(20, 2) @map("fiat_amount")
  rate              Decimal       @db.Decimal(30, 8)
  margin            Decimal       @db.Decimal(10, 4)
  networkFee        Decimal       @db.Decimal(30, 18) @map("network_fee")
  walletAddress     String?       @map("wallet_address")
  depositAddress    String?       @map("deposit_address")
  oxapayPaymentId   String?       @map("oxapay_payment_id")
  oxapayPayoutId    String?       @map("oxapay_payout_id")
  txHash            String?       @map("tx_hash")
  status            OrderStatus   @default(PENDING)
  expiresAt         DateTime?     @map("expires_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  @@map("crypto_orders")
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model CoinSetting {
  id            String   @id @default(cuid())
  coinSymbol    String   @map("coin_symbol")
  network       String
  buyMargin     Decimal  @db.Decimal(10, 4) @map("buy_margin")
  sellMargin    Decimal  @db.Decimal(10, 4) @map("sell_margin")
  isActive      Boolean  @default(true) @map("is_active")
  minBuy        Decimal  @db.Decimal(20, 2) @map("min_buy")
  maxBuy        Decimal  @db.Decimal(20, 2) @map("max_buy")
  minSell       Decimal  @db.Decimal(20, 2) @map("min_sell")
  maxSell       Decimal  @db.Decimal(20, 2) @map("max_sell")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([coinSymbol, network])
  @@map("coin_settings")
}

model PaymentMethod {
  id          String   @id @default(cuid())
  type        String
  name        String
  accountNo   String?  @map("account_no")
  accountName String?  @map("account_name")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("payment_methods")
}

model Admin {
  id            String       @id @default(cuid())
  username      String       @unique
  passwordHash  String       @map("password_hash")
  name          String
  isActive      Boolean      @default(true) @map("is_active")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  approvedDeposits    Deposit[]
  approvedWithdrawals Withdrawal[]

  @@map("admins")
}

model ReferralSetting {
  id              String   @id @default(cuid())
  referrerBonus   Decimal  @db.Decimal(20, 2) @map("referrer_bonus")
  refereeBonus    Decimal  @db.Decimal(20, 2) @map("referee_bonus")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("referral_settings")
}
